{% extends 'base.html' %}
{% block content %}
    {% verbatim %}
    <div id="app">
        <div class="container">
            <h1>{{ appName }}</h1>
            <div class="row">
                <div class="col-md-4">
                    <h3>Add Person</h3>
                    <form id="add-person" @submit.prevent="addPerson">
                        <div class="form-group">
                            <label for="id_date" class="requiredField">Date</label>
                            <div>
                                <input type="date" v-model="newPerson.date" class="form-control" id="id_date" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_name" class="requiredField">Name</label>
                            <div>
                                <input type="text" v-model="newPerson.name" maxlength="128"
                                       class="textinput form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_address" class="requiredField">Address</label>
                            <div>
                                <input type="text" v-model="newPerson.address" maxlength="100"
                                       class="textinput form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_age" class="requiredField">Age</label>
                            <div>
                                <input type="number" v-model="newPerson.age" min="0" class="numberinput form-control"
                                       required>
                            </div>
                        </div>
                        <button class="btn btn-primary form-control" type="submit">SUBMIT</button>
                    </form>


                    <div id="form-errors" class="text-danger"></div>
                </div>
                <div class="col-md-8">
                    <h3>Persons</h3>
                    <table id="person-table" class="table table-striped">
                        <tr>
                            <th>Name</th>
                            <th>Address</th>
                            <th>Age</th>
                            <th>Date</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                        <tr v-if="persons.length" v-for="person in persons" :key="person.id">
                            <td>{{ person.name }}</td>
                            <td>{{ person.address }}</td>
                            <td>{{ person.age }}</td>
                            <td>{{ person.date }}</td>
                            <td>
                                <button class="btn btn-success" @click="editPerson(person)" data-toggle="modal"
                                        data-target="#myModal">
                                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                </button>
                            </td>
                            <td>
                                <button class="btn btn-danger" @click="confirmDeletePerson(person.id)"
                                        data-toggle="modal">
                                    <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                </button>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">Update Person</h4>
                    </div>
                    <form id="update-person" @submit.prevent="updatePerson">
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="id_name_modal">Name</label>
                                <input type="text" name="name" v-model="editedPerson.name" maxlength="128"
                                       class="textinput form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="id_address_modal">Address</label>
                                <input type="text" name="address" v-model="editedPerson.address" maxlength="100"
                                       class="textinput form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="id_age_modal">Age</label>
                                <input type="number" name="age" v-model="editedPerson.age" min="0"
                                       class="numberinput form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="id_date_modal">Date</label>
                                <input type="date" name="date" v-model="editedPerson.date"
                                       class="form-control" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save changes</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                Close
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <div class="modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Update Person</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="update-person" action="">
                            <div class="modal-body">
                                <label for="id_name_modal">Name</label>
                                <input type="text" name="name" maxlength="128" class="textinput form-control" required
                                       id="id_name_modal">
                                <label for="id_address_modal">Address</label>
                                <input type="text" name="address" maxlength="100" class="textinput form-control"
                                       required
                                       id="id_address_modal">
                                <label for="id_age_modal">Age</label>
                                <input type="number" name="age" min="0" class="numberinput form-control" required
                                       id="id_age_modal">
                                <label for="id_date_modal">Date</label>
                                <input type="date" name="date" class="form-control" required id="id_date_modal">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add the Bootstrap modal for confirmation -->
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog"
             aria-labelledby="deleteConfirmModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this person?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteButton"
                                @click="deletePerson">Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endverbatim %}
{% endblock %}


{% block script %}
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    appName: 'Taskson',
                    persons: [],
                    newPerson: {
                        name: '',
                        address: '',
                        age: '',
                        date: '',
                    },
                    editedPerson: {  // Add an editedPerson object to hold data for editing
                        id: '',
                        name: '',
                        address: '',
                        age: '',
                        date: '',
                    },
                    deleteConfirmation: {
                        personId: null, // Add a property to store the person's ID
                    },
                };
            },
            methods: {
                fetchPersons() {
                    fetch("{% url 'persons' %}")  // Use Django's URL template tag to get the API URL
                        .then(response => response.json())
                        .then(data => {
                            this.persons = data.persons;  // Update the persons array with API data
                        })
                        .catch(error => {
                            console.error("Error fetching data:", error);
                        });
                },

                addPerson() {
                    // Prepare the data for the POST request
                    const formData = {
                        name: this.newPerson.name,
                        address: this.newPerson.address,
                        age: this.newPerson.age,
                        date: this.newPerson.date,
                    };

                    fetch("{% url 'person_create' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken, // Include the CSRF token
                        },
                        body: JSON.stringify(formData),
                    })
                        .then(response => {
                            if (response.status === 201) {
                                // Clear the form and update the persons list
                                this.newPerson = {
                                    name: '',
                                    address: '',
                                    age: '',
                                    date: '',
                                };
                                this.fetchPersons();
                            } else {
                                // Handle errors if needed
                                console.error("Error creating person object");
                            }
                        })
                        .catch(error => {
                            console.error("Error creating person object:", error);
                        });
                },

                editPerson(person) {
                    // Set the editedPerson data to the selected person's data
                    this.editedPerson.id = person.id;
                    this.editedPerson.name = person.name;
                    this.editedPerson.address = person.address;
                    this.editedPerson.age = person.age;
                    this.editedPerson.date = person.date;
                },
                updatePerson() {
                    if (!this.editedPerson.id) {
                        console.error("Invalid person ID.");
                        return;
                    }

                    const formData = {
                        name: this.editedPerson.name,
                        address: this.editedPerson.address,
                        age: this.editedPerson.age,
                        date: this.editedPerson.date,
                    };

                    fetch(`{% url 'person_update' person_id=0 %}`.replace("0", this.editedPerson.id), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify(formData),
                    })
                        .then(response => {
                            if (response.status === 200) {
                                $('#myModal').modal('hide');
                                this.fetchPersons();
                            } else {
                                console.error("Error updating person object");
                            }
                        })
                        .catch(error => {
                            console.error("Error updating person object:", error);
                        });
                },

                confirmDeletePerson(personId) {
                    $('#deleteConfirmModal').modal('show');
                    this.deleteConfirmation.personId = personId;

                },
                deletePerson() {
                    const personId = this.deleteConfirmation.personId;

                    if (!personId) {
                        console.error("Invalid person ID.");
                        return;
                    }

                    const formData = new FormData();
                    formData.append('person_id', personId);

                    fetch('{% url 'person_delete' %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                        },
                        body: formData,
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Handle success, e.g., remove the deleted person from your data array
                                this.fetchPersons();  // Refresh the list of persons
                                $('#deleteConfirmModal').modal('hide') // Close the modal
                            } else {
                                // Handle error, e.g., show an error message
                                console.error("Error deleting person:", data.message);
                            }
                        })
                        .catch(error => {
                            console.error("Error deleting person:", error);
                        });
                },
            },
            mounted() {
                this.fetchPersons();
            },
        });
        app.mount("#app");

        // Function to get the CSRF token
        function getCookie(name) {
            let cookieValue = null;
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');
    </script>

{% endblock %}